<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ICU Stock Variance Checker</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tabulator -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#04111f;
      --bg1:#071b2a;
      --panel: rgba(10, 33, 56, .78);
      --panel2: rgba(8, 28, 48, .62);

      --text:#e7f1ff;
      --muted:#a9c2df;
      --line:rgba(255,255,255,.10);

      --aqua:#2dd4bf;
      --sky:#60a5fa;
      --violet:#a78bfa;

      --good:#22c55e;
      --warn:#fbbf24;
      --bad:#ef4444;

      --shadow: 0 16px 40px rgba(0,0,0,.38);
      --glow: 0 0 0 1px rgba(96,165,250,.18), 0 0 24px rgba(96,165,250,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 12% 0%, rgba(96,165,250,.18), transparent 62%),
        radial-gradient(900px 600px at 92% 18%, rgba(45,212,191,.14), transparent 60%),
        radial-gradient(700px 500px at 55% 0%, rgba(167,139,250,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 60%, #030d18);
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header{
      position:sticky;
      top:0;
      z-index:50;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(3, 13, 24, .60);
      backdrop-filter: blur(12px);
    }

    .headrow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    h1{
      margin:0;
      font-size:17px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .pill{
      font-size:12px;
      padding:4px 10px;
      border:1px solid rgba(96,165,250,.28);
      background: linear-gradient(135deg, rgba(96,165,250,.16), rgba(45,212,191,.10));
      border-radius:999px;
      color:var(--text);
      white-space:nowrap;
    }

    .sub{
      margin:6px 0 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .wrap{
      flex:1;
      width:100%;
      padding:12px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:12px;
      overflow:hidden;
      position:relative;
    }
    .panel::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 200px at 10% 0%, rgba(96,165,250,.20), transparent 60%),
        radial-gradient(600px 200px at 90% 0%, rgba(45,212,191,.16), transparent 55%);
      opacity:.55;
      pointer-events:none;
    }
    .panel > *{position:relative}

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    label{font-size:12px; color:var(--muted)}
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
      flex:1;
    }
    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(96,165,250,.25);
      background: rgba(4,17,31,.35);
      color:var(--text);
      box-shadow: var(--glow);
    }
    .ctrl{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:180px;
      flex:1;
    }
    .ctrl input, .ctrl select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(4,17,31,.35);
      color:var(--text);
      outline:none;
    }
    .ctrl input:focus, .ctrl select:focus{
      border-color: rgba(96,165,250,.40);
      box-shadow: var(--glow);
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      color:#02101c;
      background: linear-gradient(135deg, var(--aqua), rgba(96,165,250,.98));
      box-shadow: 0 10px 22px rgba(45,212,191,.16);
      transition: transform .06s ease, filter .2s ease;
      white-space:nowrap;
    }
    button:hover{ filter:brightness(1.06) }
    button:active{ transform: translateY(1px) }

    .btn-ghost{
      color:var(--text);
      background: rgba(4,17,31,.28);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn-danger{
      color:#fff;
      background: rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.35);
      box-shadow:none;
    }

    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      align-items:stretch;
    }
    .stat{
      flex:1;
      min-width:190px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(4,17,31,.22);
    }
    .stat .k{font-size:12px;color:var(--muted); margin-bottom:6px}
    .stat .v{
      font-size:16px;
      font-weight:900;
      background: linear-gradient(90deg, rgba(231,241,255,.96), rgba(96,165,250,.92));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    /* Table takes the rest of the page */
    #tableWrap{
      flex:1;
      min-height:260px;
    }
    #table{
      width:100%;
      height:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background: rgba(4,17,31,.18);
    }

    /* Tabulator dark (page only) */
    .tabulator{
      background: transparent;
      border:none;
      color: var(--text);
    }
    .tabulator .tabulator-header{
      background: linear-gradient(180deg, rgba(7,27,42,.92), rgba(7,27,42,.72));
      border-bottom:1px solid rgba(255,255,255,.10);
      color:#eaf3ff;
    }
    .tabulator .tabulator-header .tabulator-col{
      background: transparent;
      border-right:1px solid rgba(255,255,255,.08);
    }
    .tabulator-row{
      background: rgba(4,17,31,.10);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .tabulator-row:hover{
      background: rgba(96,165,250,.10);
    }
    .tabulator-row .tabulator-cell{
      border-right:1px solid rgba(255,255,255,.06);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .b-match{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); color:#b6f7c9; }
    .b-surplus{ background: rgba(45,212,191,.14); border-color: rgba(45,212,191,.30); color:#bffcf4; }
    .b-shortage{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.30); color:#ffb4b4; }
    .b-pending{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.30); color:#ffe7b0; }

    /* Unified variance columns background */
    .tabulator .tabulator-cell.variance-col{
      background: linear-gradient(180deg, rgba(96,165,250,.12), rgba(96,165,250,.06)) !important;
    }
    .tabulator .tabulator-cell.money-col{
      background: linear-gradient(180deg, rgba(167,139,250,.12), rgba(167,139,250,.06)) !important;
    }
    .tabulator .tabulator-header .tabulator-col[tabulator-field="variance"]{
      background: linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.10)) !important;
    }
    .tabulator .tabulator-header .tabulator-col[tabulator-field="moneyVariance"]{
      background: linear-gradient(180deg, rgba(167,139,250,.18), rgba(167,139,250,.10)) !important;
    }

    .vtext{
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(4,17,31,.35);
      border:1px solid rgba(255,255,255,.10);
    }
    /* Actual - System: negative shortage (red), positive surplus (teal) */
    .vshort{ color:#ffb4b4; border-color: rgba(239,68,68,.28); }
    .vsurp{ color:#99fff1; border-color: rgba(45,212,191,.28); }
    .vzero{ color:#b6f7c9; border-color: rgba(34,197,94,.28); }
    .vpending{ color:#ffe7b0; border-color: rgba(251,191,36,.28); }

    footer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      color:rgba(231,241,255,.78);
      font-size:12px;
      text-align:center;
      background: rgba(3, 13, 24, .55);
      backdrop-filter: blur(12px);
    }

    .toast{
      position: fixed;
      right: 14px;
      bottom: 14px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(4,17,31,.88);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      line-height: 1.35;
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast .small{ color: var(--muted); font-size: 12px; margin-top:4px; }
  </style>
</head>

<body>
<header>
  <div class="headrow">
    <div>
      <h1>
        ICU Stock Variance Checker
        <span class="pill">Qty Variance = Actual ‚àí System</span>
        <span class="pill">Minus (‚àí) = Shortage ‚Ä¢ Plus (+) = Surplus</span>
        <span class="pill">All numbers = 2 decimals</span>
      </h1>
      <p class="sub">
        Upload stock file ‚Üí enter Actual Qty ‚Üí review variance + money impact ‚Üí export simple A4 PDF / Excel.
      </p>
    </div>
    <div class="btns">
      <button class="btn-ghost" id="btnLoadSaved">Load Saved Actual</button>
      <button class="btn-danger" id="btnClearSaved">Clear Saved</button>
    </div>
  </div>
</header>

<div class="wrap">

  <div class="panel">
    <div class="controls">
      <div class="field" style="min-width:320px">
        <label for="fileInput">Upload Excel / XLS / XLSX (Required: <b>Item Name</b>, <b>PackQty</b> ‚Äî Optional: <b>Pack Cost</b>, <b>Total Cost</b>)</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv,.htm,.html" />
        <div class="mini" id="fileLabel">No file loaded</div>
      </div>

      <div class="ctrl" style="max-width:300px">
        <label for="aggMode">Import Mode</label>
        <select id="aggMode">
          <option value="itemname" selected>Group by Item Name (sum PackQty + sum Total Cost)</option>
          <option value="none">No grouping (raw rows)</option>
        </select>
        <div class="mini">Grouping avoids duplicates.</div>
      </div>

      <div class="ctrl" style="max-width:300px">
        <label for="searchBox">Search Item Name</label>
        <input id="searchBox" type="text" placeholder="Type to search..." />
        <div class="mini" id="selectedInfo">Selected: 0</div>
      </div>

      <div class="ctrl" style="max-width:320px">
        <label for="varianceFilter">Filter</label>
        <select id="varianceFilter">
          <option value="all" selected>All items</option>
          <option value="pending">Not counted (Actual empty)</option>
          <option value="match">Match (Variance = 0)</option>
          <option value="shortage">Shortage (Variance &lt; 0)</option>
          <option value="surplus">Surplus (Variance &gt; 0)</option>
          <option value="mismatch">Mismatch only (Variance ‚â† 0)</option>
        </select>
      </div>

      <div class="ctrl" style="max-width:260px">
        <label for="actualBox">Actual Qty (apply to selected)</label>
        <input id="actualBox" type="number" min="0" step="0.01" placeholder="0.00" />
      </div>

      <div class="btns">
        <button id="btnApplyActual">Apply Actual</button>
        <button class="btn-ghost" id="btnClearSelected">Clear Selected Actual</button>
        <button class="btn-ghost" id="btnUndoBaseline">Undo (Revert Actual)</button>
        <button class="btn-danger" id="btnClearTable">Clear Table</button>
      </div>

      <div class="btns">
        <button id="btnExportPDF">Export PDF (A4)</button>
        <button class="btn-ghost" id="btnExportMismatchPDF">Mismatch Only PDF</button>
        <button id="btnExportExcel">Export Excel</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat"><div class="k">Total Items</div><div class="v" id="stTotal">0.00</div></div>
      <div class="stat"><div class="k">Counted Items</div><div class="v" id="stCounted">0.00</div></div>
      <div class="stat"><div class="k">Mismatched Items</div><div class="v" id="stMismatch">0.00</div></div>
      <div class="stat"><div class="k">Total Qty Variance (Œ£ Actual‚àíSystem)</div><div class="v" id="stQtyVar">0.00</div></div>
      <div class="stat"><div class="k">Money Variance (Œ£ ActualCost‚àíSystemCost)</div><div class="v" id="stMoneyVar">0.00</div></div>
    </div>

    <div class="mini">
      <b>Note:</b> System Cost = Total Cost (if available) OR (Pack Cost √ó PackQty). Actual Cost = (Actual Qty √ó Pack Cost).
    </div>
  </div>

  <div id="tableWrap" class="panel" style="padding:0">
    <div id="table"></div>
  </div>

</div>

<footer>Designed by Mr. Mohamed Ghonim - ICU head Nurse</footer>
<div class="toast" id="toast"></div>

<script>
  const LS_KEY = "icu_stock_variance_actual_singlepage_v1";

  let table = null;
  let lastLoadedFilename = "";
  let baselineActualMap = {}; // undo baseline after import

  // ---------- helpers ----------
  function toast(msg, small=""){
    const t = document.getElementById("toast");
    t.innerHTML = `<div>${msg}</div>${small ? `<div class="small">${small}</div>` : ""}`;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function normStr(v){
    return String(v ?? "")
      .replace(/\u00a0/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }
  function keyStr(v){
    return normStr(v).toLowerCase().replace(/[^a-z0-9]+/g, "");
  }
  function toNumber(v){
    if(v === null || v === undefined || v === "") return null;
    const s = String(v).replace(/,/g,"").trim();
    if(s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }
  function round2(n){
    if(n === null || n === undefined || !Number.isFinite(n)) return null;
    return Math.round(n * 100) / 100;
  }
  function fmt2(n){
    if(n === null || n === undefined || !Number.isFinite(n)) return "";
    return Number(n).toFixed(2);
  }

  function getSavedMap(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){
      return {};
    }
  }
  function saveActualMap(map){
    localStorage.setItem(LS_KEY, JSON.stringify(map));
  }
  function persistActualFromTable(){
    if(!table) return;
    const map = {};
    table.getData().forEach(r=>{
      const k = keyStr(r.itemName);
      const v = toNumber(r.actualQty);
      if(k && v !== null) map[k] = round2(v);
    });
    saveActualMap(map);
  }

  // ‚úÖ variance logic: Actual ‚àí System (minus = shortage, plus = surplus)
  function computeRow(data){
    const systemQty  = Number(data.systemQty) || 0;
    const packCost   = Number(data.packCost) || 0;
    const systemCost = Number(data.systemTotalCost) || 0;

    const actualQty = toNumber(data.actualQty);

    const variance = (actualQty === null) ? null : round2(actualQty - systemQty);
    const actualCost = (actualQty === null) ? null : round2(actualQty * packCost);
    const moneyVariance = (actualQty === null) ? null : round2(actualCost - systemCost);

    let status = "Not counted";
    if(actualQty === null) status = "Not counted";
    else if(Math.abs(variance) < 1e-9) status = "Match";
    else if(variance < 0) status = "Shortage";
    else status = "Surplus";

    return {
      ...data,
      actualQty: (actualQty === null ? "" : round2(actualQty)),
      variance,
      status,
      actualTotalCost: actualCost,
      moneyVariance
    };
  }

  function statusBadgeFormatter(cell){
    const v = cell.getValue();
    const cls =
      v === "Match" ? "b-match" :
      v === "Surplus" ? "b-surplus" :
      v === "Shortage" ? "b-shortage" : "b-pending";
    return `<span class="badge ${cls}">${v}</span>`;
  }

  function varianceFormatter(cell){
    const v = cell.getValue();
    const row = cell.getRow().getData();
    const act = toNumber(row.actualQty);
    if(act === null) return `<span class="vtext vpending">‚è≥ Pending</span>`;

    const n = Number(v);
    if(!Number.isFinite(n)) return "";
    if(Math.abs(n) < 1e-9) return `<span class="vtext vzero">‚úÖ ${fmt2(0)}</span>`;

    // negative shortage, positive surplus
    if(n < 0) return `<span class="vtext vshort">‚ñº ${fmt2(n)}</span>`;
    return `<span class="vtext vsurp">‚ñ≤ +${fmt2(n)}</span>`;
  }

  function moneyVarianceFormatter(cell){
    const v = cell.getValue();
    const row = cell.getRow().getData();
    const act = toNumber(row.actualQty);
    if(act === null) return `<span class="vtext vpending">‚è≥ Pending</span>`;

    const n = Number(v);
    if(!Number.isFinite(n)) return "";
    if(Math.abs(n) < 1e-9) return `<span class="vtext vzero">‚úÖ ${fmt2(0)}</span>`;

    if(n < 0) return `<span class="vtext vshort">üí∏ ${fmt2(n)}</span>`;
    return `<span class="vtext vsurp">üí∞ +${fmt2(n)}</span>`;
  }

  function updateSelectedInfo(){
    const el = document.getElementById("selectedInfo");
    if(!table){ el.textContent = "Selected: 0"; return; }
    el.textContent = `Selected: ${table.getSelectedRows().length}`;
  }

  function updateStats(){
    const stTotal = document.getElementById("stTotal");
    const stCounted = document.getElementById("stCounted");
    const stMismatch = document.getElementById("stMismatch");
    const stQtyVar = document.getElementById("stQtyVar");
    const stMoneyVar = document.getElementById("stMoneyVar");

    if(!table){
      stTotal.textContent = "0.00";
      stCounted.textContent = "0.00";
      stMismatch.textContent = "0.00";
      stQtyVar.textContent = "0.00";
      stMoneyVar.textContent = "0.00";
      return;
    }

    const rows = table.getData();
    const total = rows.length;

    let counted = 0, mismatch = 0;
    let qtyVarSum = 0, moneyVarSum = 0;

    rows.forEach(r=>{
      const act = toNumber(r.actualQty);
      if(act === null) return;
      counted++;

      const v = Number(r.variance);
      if(Number.isFinite(v)){
        qtyVarSum += v;
        if(Math.abs(v) >= 1e-9) mismatch++;
      }
      const mv = Number(r.moneyVariance);
      if(Number.isFinite(mv)) moneyVarSum += mv;
    });

    stTotal.textContent = fmt2(total);
    stCounted.textContent = fmt2(counted);
    stMismatch.textContent = fmt2(mismatch);
    stQtyVar.textContent = fmt2(round2(qtyVarSum) ?? 0);
    stMoneyVar.textContent = fmt2(round2(moneyVarSum) ?? 0);
  }

  // ---------- filtering ----------
  function applyFilters(){
    if(!table) return;

    const query = normStr(document.getElementById("searchBox").value).toLowerCase();
    const mode  = document.getElementById("varianceFilter").value;

    table.clearFilter(true);

    if(query){
      table.addFilter(d => String(d.itemName||"").toLowerCase().includes(query));
    }

    table.addFilter(d=>{
      const act = toNumber(d.actualQty);
      const varr = (act === null) ? null : (act - (Number(d.systemQty)||0)); // Actual - System

      if(mode === "all") return true;
      if(mode === "pending") return act === null;
      if(mode === "match") return act !== null && Math.abs(varr) < 1e-9;
      if(mode === "shortage") return act !== null && varr < 0;
      if(mode === "surplus") return act !== null && varr > 0;
      if(mode === "mismatch") return act !== null && Math.abs(varr) >= 1e-9;
      return true;
    });
  }

  // ---------- import ----------
  function findHeaderRow(aoa){
    for(let i=0; i<Math.min(aoa.length, 80); i++){
      const row = aoa[i] || [];
      const keys = row.map(c=>keyStr(c));
      const hasItemName = keys.includes("itemname");
      const hasPackQty  = keys.includes("packqty");
      if(hasItemName && hasPackQty) return i;
    }
    return -1;
  }

  function buildRowsFromAOA(aoa, {groupByItemName=true}){
    const hdrIdx = findHeaderRow(aoa);
    if(hdrIdx < 0) throw new Error("Headers not found. Required: 'Item Name' and 'PackQty'.");

    const header = aoa[hdrIdx].map(h=>keyStr(h));
    const idxItemName = header.indexOf("itemname");
    const idxPackQty  = header.indexOf("packqty");
    const idxPackCost = header.indexOf("packcost");
    const idxTotalCost = header.indexOf("totalcost");

    if(idxItemName < 0 || idxPackQty < 0) throw new Error("Cannot locate Item Name / PackQty columns.");

    const saved = getSavedMap();

    const rawRows = [];
    for(let r = hdrIdx + 1; r < aoa.length; r++){
      const row = aoa[r] || [];
      const itemName = normStr(row[idxItemName]);
      if(!itemName) continue;

      const sysQty = toNumber(row[idxPackQty]) ?? 0;

      let packCost = (idxPackCost >= 0) ? toNumber(row[idxPackCost]) : null;
      let totalCost = (idxTotalCost >= 0) ? toNumber(row[idxTotalCost]) : null;

      if(totalCost === null && packCost !== null) totalCost = packCost * sysQty;
      if((packCost === null || !Number.isFinite(packCost)) && totalCost !== null && sysQty > 0) packCost = totalCost / sysQty;

      const k = keyStr(itemName);
      const savedAct = (k && (k in saved)) ? saved[k] : "";

      rawRows.push({
        itemName,
        systemQty: round2(sysQty) ?? 0,
        packCost: round2(packCost ?? 0) ?? 0,
        systemTotalCost: round2(totalCost ?? ((packCost ?? 0) * sysQty)) ?? 0,
        actualQty: savedAct === "" ? "" : round2(Number(savedAct)),
        variance: null,
        status: "Not counted",
        actualTotalCost: null,
        moneyVariance: null
      });
    }
    if(!rawRows.length) throw new Error("No item rows found after header.");

    if(!groupByItemName){
      return rawRows.map((r, i)=>({ id: i+1, ...computeRow(r) }));
    }

    // group by item name
    const map = new Map();
    rawRows.forEach(r=>{
      const k = keyStr(r.itemName);
      if(!k) return;
      if(!map.has(k)){
        map.set(k, { itemName: r.itemName, systemQty: 0, systemTotalCost: 0, actualQty: r.actualQty });
      }
      const o = map.get(k);
      o.systemQty += Number(r.systemQty)||0;
      o.systemTotalCost += Number(r.systemTotalCost)||0;
      // keep any saved actual if exists
      if(o.actualQty === "" && r.actualQty !== "") o.actualQty = r.actualQty;
    });

    const out = Array.from(map.values()).map(o=>{
      const qty = Number(o.systemQty)||0;
      const sysCost = Number(o.systemTotalCost)||0;
      const packCost = (qty > 0) ? (sysCost/qty) : 0;

      return {
        itemName: o.itemName,
        systemQty: round2(qty) ?? 0,
        packCost: round2(packCost) ?? 0,
        systemTotalCost: round2(sysCost) ?? 0,
        actualQty: o.actualQty === "" ? "" : round2(Number(o.actualQty)),
        variance: null,
        status: "Not counted",
        actualTotalCost: null,
        moneyVariance: null
      };
    }).sort((a,b)=> String(a.itemName).localeCompare(String(b.itemName)));

    return out.map((r, i)=>({ id: i+1, ...computeRow(r) }));
  }

  async function parseFileToAOA(file){
    const buf = await file.arrayBuffer();
    try{
      const wb = XLSX.read(buf, { type:"array" });
      const first = wb.SheetNames[0];
      const ws = wb.Sheets[first];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    }catch(e){
      const text = new TextDecoder("utf-8").decode(new Uint8Array(buf));
      const dp = new DOMParser();
      const doc = dp.parseFromString(text, "text/html");
      const tableEl = doc.querySelector("table");
      if(!tableEl) throw new Error("Could not parse file as Excel or HTML table.");
      const ws = XLSX.utils.table_to_sheet(tableEl, { raw:true });
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    }
  }

  function setFileLabel(name){
    const el = document.getElementById("fileLabel");
    if(!name){ el.textContent = "No file loaded"; return; }
    el.textContent = `Loaded: ${name} ‚Ä¢ ${new Date().toLocaleString()}`;
  }

  // ---------- table init ----------
  function initTable(){
    if(table) return;

    table = new Tabulator("#table", {
      layout: "fitColumns",
      height: "calc(100vh - 340px)",
      placeholder: "Upload a stock file to start‚Ä¶",
      index: "id",
      selectable: true,
      reactiveData: true,

      rowFormatter: function(row){
        const d = row.getData();
        const act = toNumber(d.actualQty);
        const sys = Number(d.systemQty)||0;
        const varr = (act === null) ? null : (act - sys); // Actual - System

        if(act === null){
          row.getElement().style.background = "rgba(251,191,36,.05)";
          row.getElement().style.borderLeft = "4px solid rgba(251,191,36,.45)";
        }else if(Math.abs(varr) < 1e-9){
          row.getElement().style.background = "rgba(34,197,94,.05)";
          row.getElement().style.borderLeft = "4px solid rgba(34,197,94,.55)";
        }else if(varr < 0){
          row.getElement().style.background = "rgba(239,68,68,.05)";
          row.getElement().style.borderLeft = "4px solid rgba(239,68,68,.55)";
        }else{
          row.getElement().style.background = "rgba(45,212,191,.05)";
          row.getElement().style.borderLeft = "4px solid rgba(45,212,191,.55)";
        }
      },

      columns: [
        {title:"", formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:52},
        {title:"#", field:"id", width:70, hozAlign:"center"},
        {title:"Item Name", field:"itemName", minWidth:340},

        {title:"System Qty (PackQty)", field:"systemQty", width:170, hozAlign:"right",
          formatter:(c)=> fmt2(Number(c.getValue()||0))
        },
        {title:"Pack Cost", field:"packCost", width:130, hozAlign:"right",
          formatter:(c)=> fmt2(Number(c.getValue()||0))
        },
        {title:"System Cost (Total)", field:"systemTotalCost", width:170, hozAlign:"right",
          formatter:(c)=> fmt2(Number(c.getValue()||0))
        },

        {title:"Actual Qty", field:"actualQty", width:140, hozAlign:"right",
          editor:"number",
          editorParams:{min:0, step:0.01},
          formatter:(c)=>{
            const v = toNumber(c.getValue());
            return v === null ? "" : fmt2(v);
          },
          cellEdited:(cell)=>{
            const row = cell.getRow();
            const d = row.getData();
            // normalize to 2 decimals
            const v = toNumber(d.actualQty);
            d.actualQty = (v === null ? "" : round2(v));
            row.update(computeRow(d));
            persistActualFromTable();
            updateStats();
          }
        },

        {title:"Actual Cost", field:"actualTotalCost", width:160, hozAlign:"right",
          formatter:(c)=>{
            const d = c.getRow().getData();
            const act = toNumber(d.actualQty);
            if(act === null) return "";
            return fmt2(Number(c.getValue()||0));
          }
        },

        {title:"Qty Variance (Actual ‚àí System)", field:"variance", width:240, hozAlign:"center",
          formatter:varianceFormatter, cssClass:"variance-col"
        },

        {title:"Money Variance (ActualCost ‚àí SystemCost)", field:"moneyVariance", width:280, hozAlign:"center",
          formatter:moneyVarianceFormatter, cssClass:"money-col"
        },

        {title:"Status", field:"status", width:160, hozAlign:"center", formatter:statusBadgeFormatter},
      ],

      initialSort: [{column:"itemName", dir:"asc"}],

      rowSelectionChanged: function(){
        updateSelectedInfo();
        const rows = table.getSelectedRows();
        if(rows.length === 1){
          const d = rows[0].getData();
          const v = toNumber(d.actualQty);
          document.getElementById("actualBox").value = (v === null ? "" : fmt2(v));
        }
      }
    });

    // keep table height correct on resize
    window.addEventListener("resize", ()=>{
      try{ table.setHeight("calc(100vh - 340px)"); }catch(e){}
    });
  }

  // ---------- actions ----------
  function applyActualToSelected(){
    if(!table) return;
    const v = toNumber(document.getElementById("actualBox").value);
    if(v === null){
      toast("Actual Qty is empty/invalid.", "Enter a number like 5.00 then Apply.");
      return;
    }
    const rows = table.getSelectedRows();
    if(!rows.length){
      toast("No selection.", "Select item(s) in the table first.");
      return;
    }
    rows.forEach(r=>{
      const d = r.getData();
      d.actualQty = round2(v);
      r.update(computeRow(d));
    });
    persistActualFromTable();
    updateStats();
    toast("Applied Actual.", `Updated ${rows.length} item(s).`);
  }

  function clearSelectedActual(){
    if(!table) return;
    const rows = table.getSelectedRows();
    if(!rows.length){
      toast("No selection.", "Select item(s) in the table first.");
      return;
    }
    rows.forEach(r=>{
      const d = r.getData();
      d.actualQty = "";
      r.update(computeRow(d));
    });
    persistActualFromTable();
    updateStats();
    toast("Cleared selected actual.", `Cleared ${rows.length} item(s).`);
  }

  function setBaselineFromCurrent(){
    if(!table) return;
    baselineActualMap = {};
    table.getData().forEach(r=>{
      const k = keyStr(r.itemName);
      const v = toNumber(r.actualQty);
      baselineActualMap[k] = (v === null ? "" : round2(v));
    });
  }

  function undoToBaseline(){
    if(!table) return;
    const data = table.getData();
    data.forEach(r=>{
      const k = keyStr(r.itemName);
      const base = (k in baselineActualMap) ? baselineActualMap[k] : "";
      r.actualQty = (base === "" ? "" : round2(Number(base)));
      Object.assign(r, computeRow(r));
    });
    table.replaceData(data);
    persistActualFromTable();
    updateStats();
    toast("Undo completed.", "Reverted Actual Qty to the baseline (after import).");
  }

  function clearTable(){
    if(table){
      table.clearData();
      updateSelectedInfo();
      updateStats();
    }
    baselineActualMap = {};
    lastLoadedFilename = "";
    setFileLabel("");
    toast("Table cleared.");
  }

  function loadSavedActual(){
    if(!table || table.getDataCount?.() === 0){
      toast("No table data.", "Upload a file first.");
      return;
    }
    const saved = getSavedMap();
    const data = table.getData();
    let hits = 0;
    data.forEach(r=>{
      const k = keyStr(r.itemName);
      if(k in saved){
        r.actualQty = round2(Number(saved[k]));
        Object.assign(r, computeRow(r));
        hits++;
      }
    });
    table.replaceData(data);
    setBaselineFromCurrent();
    updateStats();
    toast("Loaded saved actual.", hits ? `Matched ${hits} item(s).` : "No saved matches.");
  }

  // ---------- exports ----------
  function getActiveData(){
    if(!table) return [];
    return table.getRows("active").map(r=>r.getData());
  }

  function exportExcel(){
    const data = getActiveData();
    if(!data.length){ toast("Nothing to export."); return; }

    const out = data.map(r=>{
      const sysQty = Number(r.systemQty)||0;
      const actQty = toNumber(r.actualQty);
      const qtyVar = (actQty === null) ? "" : round2(actQty - sysQty);

      const packCost = Number(r.packCost)||0;
      const sysCost = Number(r.systemTotalCost)||0;
      const actCost = (actQty === null) ? "" : round2(actQty * packCost);
      const moneyVar = (actQty === null) ? "" : round2(actCost - sysCost);

      return {
        "#": fmt2(r.id),
        "Item Name": r.itemName,
        "System Qty (PackQty)": fmt2(round2(sysQty)),
        "Actual Qty": actQty === null ? "" : fmt2(round2(actQty)),
        "Qty Variance (Actual-System)": qtyVar === "" ? "" : fmt2(qtyVar),
        "Pack Cost": fmt2(round2(packCost)),
        "System Cost (Total)": fmt2(round2(sysCost)),
        "Actual Cost": actCost === "" ? "" : fmt2(actCost),
        "Money Variance (ActualCost-SystemCost)": moneyVar === "" ? "" : fmt2(moneyVar),
        "Status": r.status
      };
    });

    const ws = XLSX.utils.json_to_sheet(out, { skipHeader:false });
    ws["!cols"] = [
      {wch:8}, {wch:48}, {wch:18}, {wch:12}, {wch:28},
      {wch:12}, {wch:18}, {wch:16}, {wch:34}, {wch:14}
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Variance Report");

    const fname = `ICU_Stock_Variance_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, fname);
    toast("Excel exported.", fname);
  }

  function exportPDF(data, title, filenamePrefix){
    if(!data.length){ toast("Nothing to export."); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

    const pageWidth  = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const footerText = "Designed by Mr. Mohamed Ghonim - ICU head Nurse";

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.text(title, 8, 10);

    doc.setFont("helvetica","normal");
    doc.setFontSize(9);
    const meta1 = lastLoadedFilename ? `File: ${lastLoadedFilename}` : "File: (not specified)";
    const meta2 = `Generated: ${new Date().toLocaleString()}`;
    doc.text(meta1, 8, 15);
    doc.text(meta2, 8, 19);

    const body = data.map(r=>{
      const sysQty = Number(r.systemQty)||0;
      const actQty = toNumber(r.actualQty);
      const qtyVar = (actQty === null) ? "" : round2(actQty - sysQty);

      const packCost = Number(r.packCost)||0;
      const sysCost = Number(r.systemTotalCost)||0;
      const actCost = (actQty === null) ? "" : round2(actQty * packCost);
      const moneyVar = (actQty === null) ? "" : round2(actCost - sysCost);

      return [
        fmt2(r.id),
        r.itemName,
        fmt2(round2(sysQty)),
        actQty === null ? "" : fmt2(round2(actQty)),
        qtyVar === "" ? "" : fmt2(qtyVar),
        fmt2(round2(packCost)),
        fmt2(round2(sysCost)),
        actCost === "" ? "" : fmt2(actCost),
        moneyVar === "" ? "" : fmt2(moneyVar),
      ];
    });

    doc.autoTable({
      startY: 23,
      head: [[ "#", "Item Name", "SysQty", "Actual", "VarQty", "PackCost", "SysCost", "ActCost", "MoneyVar" ]],
      body,
      margin: { left: 8, right: 8, top: 8, bottom: 14 },
      styles: { fontSize: 8, cellPadding: 1.5, overflow: "linebreak", textColor: 0, lineWidth: 0.1, lineColor: [200,200,200] },
      headStyles: { fillColor: [245,245,245], textColor: 0, fontStyle: "bold", lineWidth: 0.1, lineColor: [200,200,200] },
      alternateRowStyles: { fillColor: [252,252,252] },
      columnStyles: {
        0: { cellWidth: 8 },
        1: { cellWidth: 64 },
        2: { cellWidth: 14 },
        3: { cellWidth: 14 },
        4: { cellWidth: 14 },
        5: { cellWidth: 14 },
        6: { cellWidth: 18 },
        7: { cellWidth: 18 },
        8: { cellWidth: 20 },
      },
      didDrawPage: () => {
        const pageNumber = doc.internal.getNumberOfPages();
        doc.setFont("helvetica","normal");
        doc.setFontSize(9);
        doc.setTextColor(0);
        doc.text(footerText, pageWidth/2, pageHeight - 8, { align: "center" });
        doc.setFontSize(8);
        doc.text(`Page ${pageNumber}`, pageWidth/2, pageHeight - 4, { align: "center" });
      },
    });

    const fname = `${filenamePrefix}_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fname);
    toast("PDF exported.", fname);
  }

  function exportPDF_All(){
    const data = getActiveData();
    exportPDF(data, "ICU Stock Variance Report (Actual ‚àí System)", "ICU_Stock_Variance");
  }

  function exportPDF_MismatchOnly(){
    const data = getActiveData().filter(r=>{
      const act = toNumber(r.actualQty);
      if(act === null) return false;
      const sys = Number(r.systemQty)||0;
      return Math.abs(act - sys) >= 1e-9;
    });
    exportPDF(data, "ICU Stock Variance Report (Mismatch Only)", "ICU_Stock_Mismatch_Only");
  }

  // ---------- events ----------
  document.getElementById("searchBox").addEventListener("input", applyFilters);
  document.getElementById("varianceFilter").addEventListener("change", applyFilters);

  document.getElementById("btnApplyActual").addEventListener("click", applyActualToSelected);
  document.getElementById("actualBox").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") applyActualToSelected();
  });

  document.getElementById("btnClearSelected").addEventListener("click", clearSelectedActual);
  document.getElementById("btnUndoBaseline").addEventListener("click", undoToBaseline);

  document.getElementById("btnExportExcel").addEventListener("click", exportExcel);
  document.getElementById("btnExportPDF").addEventListener("click", exportPDF_All);
  document.getElementById("btnExportMismatchPDF").addEventListener("click", exportPDF_MismatchOnly);

  document.getElementById("btnClearTable").addEventListener("click", clearTable);

  document.getElementById("btnLoadSaved").addEventListener("click", loadSavedActual);
  document.getElementById("btnClearSaved").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    toast("Saved data cleared.", "This clears saved Actual values in this browser.");
  });

  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;

    try{
      toast("Reading file‚Ä¶", file.name);
      lastLoadedFilename = file.name;

      const aoa = await parseFileToAOA(file);
      const group = document.getElementById("aggMode").value === "itemname";
      const rows = buildRowsFromAOA(aoa, { groupByItemName: group });

      initTable();
      table.setData(rows);

      setFileLabel(file.name);
      applyFilters();
      updateSelectedInfo();
      updateStats();

      // baseline for undo = state right after import (with any saved actual already applied)
      setBaselineFromCurrent();

      toast("Imported successfully.", `Items loaded: ${rows.length}`);
    }catch(err){
      console.error(err);
      toast("Import failed.", String(err?.message || err));
    }
  });

  // ---------- init ----------
  initTable();
  updateSelectedInfo();
  updateStats();
</script>
</body>
</html>
