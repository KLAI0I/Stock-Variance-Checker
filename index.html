<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ICU Stock Variance Checker</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tabulator -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/css/tabulator.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/6.3.1/js/tabulator.min.js"></script>

  <!-- jsPDF + AutoTable (A4 PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/5.0.2/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS (read Excel + export Excel) -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg0:#04111f;
      --bg1:#071b2a;
      --text:#e7f1ff;
      --muted:#a9c2df;
      --line:rgba(255,255,255,.08);
      --accent:#2dd4bf;
      --accent2:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(96,165,250,.14), transparent 60%),
                  radial-gradient(1000px 700px at 90% 20%, rgba(45,212,191,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1) 60%, #030d18);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(3, 13, 24, .45);
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:50;
    }

    .topbar{
      width:100%;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:280px;
    }
    .title h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border:1px solid rgba(96,165,250,.25);
      background: rgba(96,165,250,.10);
      color: var(--text);
      border-radius:999px;
      white-space:nowrap;
    }
    .title .sub{
      margin:0;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    .container{
      width:100%;
      padding:14px 16px 16px;
      flex:1;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:12px;
      align-items:start;
      width:100%;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(15,50,82,.78), rgba(11,39,64,.78));
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
      width:100%;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:14px;
      color: #dcecff;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    label{
      font-size:12px;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 260px;
      flex:1;
    }
    input[type="file"]{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px dashed rgba(96,165,250,.25);
      background: rgba(4,17,31,.35);
      color:var(--text);
    }

    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 180px;
      flex:1;
    }
    .control input, .control select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(4,17,31,.35);
      color:var(--text);
      outline:none;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      color: #02101c;
      background: linear-gradient(135deg, var(--accent), rgba(96,165,250,.95));
      box-shadow: 0 8px 18px rgba(45,212,191,.18);
      transition: transform .06s ease, filter .2s ease;
      white-space:nowrap;
    }
    button:hover{ filter: brightness(1.05); }
    button:active{ transform: translateY(1px); }

    .btn-ghost{
      color: var(--text);
      background: rgba(4,17,31,.35);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:none;
    }
    .btn-danger{
      color:#fff;
      background: rgba(239,68,68,.18);
      border:1px solid rgba(239,68,68,.35);
      box-shadow:none;
    }

    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .note b{ color:#dcecff; }

    .stats{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    .stat{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(4,17,31,.25);
    }
    .stat .k{
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .stat .v{
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .progressWrap{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(4,17,31,.25);
    }
    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius:999px;
      transition: width .25s ease;
    }
    .progressMeta{
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
      margin-top:8px;
      gap:10px;
      flex-wrap:wrap;
    }

    /* FULL PAGE TABLE (no fixed height) */
    #table{
      margin-top:12px;
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }

    /* Tabulator dark theme */
    .tabulator{
      background: rgba(4,17,31,.25);
      color: var(--text);
      border:none;
    }
    .tabulator .tabulator-header{
      background: rgba(7,27,42,.85);
      border-bottom:1px solid var(--line);
      color: #dcecff;
    }
    .tabulator .tabulator-header .tabulator-col{
      background: transparent;
      border-right:1px solid var(--line);
    }
    .tabulator-row{
      background: rgba(4,17,31,.18);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .tabulator-row:hover{
      background: rgba(96,165,250,.10);
    }
    .tabulator-row .tabulator-cell{
      border-right:1px solid rgba(255,255,255,.06);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .b-match{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); color:#b6f7c9; }
    .b-surplus{ background: rgba(45,212,191,.14); border-color: rgba(45,212,191,.30); color:#bffcf4; }
    .b-shortage{ background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.30); color:#ffb4b4; }
    .b-pending{ background: rgba(251,191,36,.14); border-color: rgba(251,191,36,.30); color:#ffe7b0; }

    footer{
      padding:14px 16px;
      border-top:1px solid var(--line);
      color:rgba(231,241,255,.78);
      font-size:12px;
      text-align:center;
      background: rgba(3, 13, 24, .45);
      backdrop-filter: blur(10px);
    }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 420px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(4,17,31,.88);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 13px;
      line-height: 1.35;
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast .small{ color: var(--muted); font-size: 12px; margin-top:4px; }

    .mini{
      font-size:12px;
      color:var(--muted);
      margin-top:6px;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1>
        ICU Stock Variance Checker
        <span class="pill">Imports ONLY: Item Name + PackQty</span>
        <span class="pill">Variance = Actual − System</span>
      </h1>
      <p class="sub">
        Upload system file → select items → enter Actual Qty → export A4 PDF / Excel.
        (Autosaves actual values in this browser)
      </p>
    </div>

    <div class="btns">
      <button class="btn-ghost" id="btnLoadSaved">Load Saved Actual</button>
      <button class="btn-danger" id="btnClearSaved">Clear Saved</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <h2>1) Upload File + Review Items</h2>

      <div class="row">
        <div class="field">
          <label for="fileInput">Upload Excel / XLS / XLSX (must contain headers: <b>Item Name</b>, <b>PackQty</b>)</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv,.htm,.html" />
          <div class="mini" id="fileLabel">No file loaded</div>
        </div>

        <div class="control" style="max-width:260px">
          <label for="aggMode">Import Mode</label>
          <select id="aggMode">
            <option value="itemname" selected>Group by Item Name (sum PackQty)</option>
            <option value="none">No grouping (raw rows)</option>
          </select>
          <div class="mini">Grouping avoids duplicates.</div>
        </div>

        <div class="control" style="max-width:260px">
          <label for="searchBox">Search Item Name</label>
          <input id="searchBox" type="text" placeholder="Type to search..." />
          <div class="mini" id="selectedInfo">Selected: 0</div>
        </div>

        <div class="control" style="max-width:260px">
          <label for="varianceFilter">Filter</label>
          <select id="varianceFilter">
            <option value="all" selected>All items</option>
            <option value="pending">Not counted (Actual empty)</option>
            <option value="match">Match (Variance = 0)</option>
            <option value="shortage">Shortage (Variance &lt; 0)</option>
            <option value="surplus">Surplus (Variance &gt; 0)</option>
            <option value="mismatch">Only mismatched (Variance ≠ 0)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="btns">
          <button class="btn-ghost" id="btnSelectAllFiltered">Select All (Filtered)</button>
          <button class="btn-ghost" id="btnClearSelection">Clear Selection</button>
          <button class="btn-danger" id="btnClearTable">Clear Table</button>
        </div>
      </div>

      <div id="table"></div>

      <div class="note">
        <b>Note:</b> Only <b>Item Name</b> and <b>PackQty</b> are imported.
        You can edit Actual Qty directly in the table or use the “Apply Actual” tool on the right.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2>2) Enter Actual Qty + Summary + Export</h2>

      <div class="row">
        <div class="control" style="min-width:220px; flex:1">
          <label for="actualBox">Actual Qty (apply to selected rows)</label>
          <input id="actualBox" type="number" min="0" step="1" placeholder="Enter actual qty..." />
          <div class="mini">Tip: select multiple items then apply one number to all selected.</div>
        </div>

        <div class="btns" style="align-self:flex-end">
          <button id="btnApplyActual">Apply Actual</button>
          <button class="btn-ghost" id="btnClearSelected">Clear Selected Actual</button>
        </div>
      </div>

      <div class="btns" style="margin-top:12px">
        <button id="btnExportPDF">Export PDF (A4 Portrait)</button>
        <button class="btn-ghost" id="btnExportMismatchPDF">Mismatch Only PDF</button>
        <button id="btnExportExcel">Export Excel</button>
        <button class="btn-ghost" id="btnResetActual">Reset All Actual</button>
      </div>

      <div class="stats" style="margin-top:12px">
        <div class="stat">
          <div class="k">Total Items</div>
          <div class="v" id="stTotalItems">0</div>
        </div>
        <div class="stat">
          <div class="k">Counted Items</div>
          <div class="v" id="stCountedItems">0</div>
        </div>
        <div class="stat">
          <div class="k">Total System Qty</div>
          <div class="v" id="stSystem">0</div>
        </div>
        <div class="stat">
          <div class="k">Total Actual Qty</div>
          <div class="v" id="stActual">0</div>
        </div>
        <div class="stat">
          <div class="k">Total Variance</div>
          <div class="v" id="stVariance">0</div>
        </div>
        <div class="stat">
          <div class="k">Mismatched Items</div>
          <div class="v" id="stMismatch">0</div>
        </div>
      </div>

      <div class="progressWrap">
        <div class="bar"><div id="progressBar"></div></div>
        <div class="progressMeta">
          <span id="progressText">0% completed</span>
          <span>Export uses current filters</span>
        </div>
      </div>

      <div class="note">
        <b>Export behavior:</b>
        Full PDF/Excel export the <b>filtered view</b> (what you currently see).
        “Mismatch Only PDF” exports <b>only mismatches within the filtered view</b>.
      </div>
    </div>

  </div>
</div>

<footer>Designed by Mr. Mohamed Ghonim - ICU head Nurse</footer>
<div class="toast" id="toast"></div>

<script>
  const LS_KEY = "icu_stock_variance_actual_v4";

  let table = null;
  let lastLoadedFilename = "";

  // ---------- Helpers ----------
  function toast(msg, small=""){
    const t = document.getElementById("toast");
    t.innerHTML = `<div>${msg}</div>${small ? `<div class="small">${small}</div>` : ""}`;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function normStr(v){
    return String(v ?? "")
      .replace(/\u00a0/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }
  function keyStr(v){
    return normStr(v).toLowerCase().replace(/[^a-z0-9]+/g, "");
  }
  function toNumber(v){
    if(v === null || v === undefined || v === "") return null;
    const s = String(v).replace(/,/g,"").trim();
    if(s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }
  function fmtNum(n){
    if(n === null || n === undefined || !Number.isFinite(n)) return "";
    const isInt = Math.abs(n - Math.round(n)) < 1e-9;
    return isInt ? String(Math.round(n)) : String(n);
  }

  function getSavedMap(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return (obj && typeof obj === "object") ? obj : {};
    }catch(e){
      return {};
    }
  }
  function saveActualMap(map){
    localStorage.setItem(LS_KEY, JSON.stringify(map));
  }

  function computeRow(data){
    const system = Number(data.systemQty) || 0;
    const actual = toNumber(data.actualQty);
    const variance = (actual === null) ? null : (actual - system);

    let status = "Not counted";
    if(actual === null) status = "Not counted";
    else if(Math.abs(variance) < 1e-9) status = "Match";
    else if(variance > 0) status = "Surplus";
    else status = "Shortage";

    return { ...data, actualQty: (actual === null ? "" : actual), variance, status };
  }

  function statusBadgeFormatter(cell){
    const v = cell.getValue();
    const cls =
      v === "Match" ? "b-match" :
      v === "Surplus" ? "b-surplus" :
      v === "Shortage" ? "b-shortage" : "b-pending";
    return `<span class="badge ${cls}">${v}</span>`;
  }

  function varianceFormatter(cell){
    const v = cell.getValue();
    if(v === null || v === undefined || v === "") return "";
    const n = Number(v);
    if(!Number.isFinite(n)) return "";
    const cls = n > 0 ? "b-surplus" : (n < 0 ? "b-shortage" : "b-match");
    const sign = n > 0 ? "+" : "";
    return `<span class="badge ${cls}">${sign}${fmtNum(n)}</span>`;
  }

  function updateSelectedInfo(){
    const el = document.getElementById("selectedInfo");
    if(!table){ el.textContent = "Selected: 0"; return; }
    el.textContent = `Selected: ${table.getSelectedRows().length}`;
  }

  function persistActualFromTable(){
    if(!table) return;
    const map = {};
    table.getData().forEach(r=>{
      const k = keyStr(r.itemName);
      const v = toNumber(r.actualQty);
      if(k && v !== null) map[k] = v;
    });
    saveActualMap(map);
  }

  function fillActualFromSaved(){
    if(!table) return;
    const map = getSavedMap();
    const rows = table.getData();
    let hits = 0;

    rows.forEach(r=>{
      const k = keyStr(r.itemName);
      if(k in map){
        r.actualQty = map[k];
        Object.assign(r, computeRow(r));
        hits++;
      }
    });

    table.replaceData(rows);
    updateSummary();
    toast("Loaded saved actual values.", hits ? `Matched ${hits} item(s).` : "No matches found in saved data.");
  }

  // ---------- Filters ----------
  function applyFilters(){
    if(!table) return;

    const query = normStr(document.getElementById("searchBox").value).toLowerCase();
    const mode  = document.getElementById("varianceFilter").value;

    table.clearFilter(true);

    if(query){
      table.addFilter((d)=> String(d.itemName||"").toLowerCase().includes(query));
    }

    table.addFilter((d)=>{
      const act = toNumber(d.actualQty);
      const sys = Number(d.systemQty)||0;
      const varr = (act === null) ? null : (act - sys);

      if(mode === "all") return true;
      if(mode === "pending") return act === null;
      if(mode === "match") return act !== null && Math.abs(varr) < 1e-9;
      if(mode === "shortage") return act !== null && varr < 0;
      if(mode === "surplus") return act !== null && varr > 0;
      if(mode === "mismatch") return act !== null && Math.abs(varr) >= 1e-9;
      return true;
    });
  }

  // ---------- Summary / Progress ----------
  function updateSummary(){
    const totalItemsEl = document.getElementById("stTotalItems");
    const countedItemsEl = document.getElementById("stCountedItems");
    const sysEl = document.getElementById("stSystem");
    const actEl = document.getElementById("stActual");
    const varEl = document.getElementById("stVariance");
    const mismatchEl = document.getElementById("stMismatch");

    if(!table){
      totalItemsEl.textContent = "0";
      countedItemsEl.textContent = "0";
      sysEl.textContent = "0";
      actEl.textContent = "0";
      varEl.textContent = "0";
      mismatchEl.textContent = "0";
      return;
    }

    const data = table.getData();
    const total = data.length;

    let counted = 0;
    let sysSum = 0;
    let actSum = 0;
    let varSum = 0;
    let mismatch = 0;

    data.forEach(r=>{
      const sys = Number(r.systemQty) || 0;
      const act = toNumber(r.actualQty);

      sysSum += sys;
      if(act !== null){
        counted++;
        actSum += act;
        const variance = act - sys;
        varSum += variance;
        if(Math.abs(variance) >= 1e-9) mismatch++;
      }
    });

    totalItemsEl.textContent = fmtNum(total);
    countedItemsEl.textContent = fmtNum(counted);
    sysEl.textContent = fmtNum(sysSum);
    actEl.textContent = fmtNum(actSum);
    varEl.textContent = fmtNum(varSum);
    mismatchEl.textContent = fmtNum(mismatch);

    const pct = total ? Math.round((counted/total)*100) : 0;
    document.getElementById("progressBar").style.width = pct + "%";
    document.getElementById("progressText").textContent = `${pct}% completed (${counted}/${total})`;
  }

  function setFileLabel(name){
    const el = document.getElementById("fileLabel");
    if(!name){ el.textContent = "No file loaded"; return; }
    el.textContent = `Loaded: ${name} • ${new Date().toLocaleString()}`;
  }

  // ---------- Import / Parse Excel (ONLY Item Name + PackQty) ----------
  function findHeaderRow(aoa){
    for(let i=0; i<Math.min(aoa.length, 80); i++){
      const row = aoa[i] || [];
      const keys = row.map(c=>keyStr(c));
      const hasItemName = keys.includes("itemname");
      const hasPackQty  = keys.includes("packqty");
      if(hasItemName && hasPackQty) return i;
    }
    return -1;
  }

  function buildRowsFromAOA(aoa, {groupByItemName=true}){
    const hdrIdx = findHeaderRow(aoa);
    if(hdrIdx < 0) throw new Error("Headers not found. Required: 'Item Name' and 'PackQty'.");

    const header = aoa[hdrIdx].map(h=>keyStr(h));
    const idxItemName = header.indexOf("itemname");
    const idxPackQty  = header.indexOf("packqty");
    if(idxItemName < 0 || idxPackQty < 0) throw new Error("Cannot locate Item Name / PackQty columns.");

    const rawRows = [];
    for(let r = hdrIdx + 1; r < aoa.length; r++){
      const row = aoa[r] || [];
      const itemName = normStr(row[idxItemName]);
      if(!itemName) continue;
      const sys = toNumber(row[idxPackQty]) ?? 0;

      rawRows.push({ itemName, systemQty: sys, actualQty: "", variance: null, status: "Not counted" });
    }
    if(!rawRows.length) throw new Error("No item rows found after header.");

    const saved = getSavedMap();

    if(!groupByItemName){
      return rawRows.map((r, i)=>{
        const k = keyStr(r.itemName);
        if(k in saved) r.actualQty = saved[k];
        return { id: i+1, ...computeRow(r) };
      });
    }

    const map = new Map();
    rawRows.forEach(r=>{
      const k = keyStr(r.itemName);
      if(!k) return;
      if(!map.has(k)) map.set(k, { itemName: r.itemName, systemQty: 0, actualQty:"" });
      map.get(k).systemQty += Number(r.systemQty) || 0;
    });

    const out = Array.from(map.values()).sort((a,b)=> String(a.itemName).localeCompare(String(b.itemName)));
    return out.map((r, i)=>{
      const k = keyStr(r.itemName);
      if(k in saved) r.actualQty = saved[k];
      return { id: i+1, ...computeRow(r) };
    });
  }

  async function parseFileToAOA(file){
    const buf = await file.arrayBuffer();
    try{
      const wb = XLSX.read(buf, { type:"array" });
      const first = wb.SheetNames[0];
      const ws = wb.Sheets[first];
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    }catch(e){
      const text = new TextDecoder("utf-8").decode(new Uint8Array(buf));
      const dp = new DOMParser();
      const doc = dp.parseFromString(text, "text/html");
      const tableEl = doc.querySelector("table");
      if(!tableEl) throw new Error("Could not parse file as Excel or HTML table.");
      const ws = XLSX.utils.table_to_sheet(tableEl, { raw:true });
      return XLSX.utils.sheet_to_json(ws, { header:1, raw:true, blankrows:false });
    }
  }

  // ---------- Table ----------
  function initTable(){
    if(table) return;

    table = new Tabulator("#table", {
      layout: "fitColumns",
      responsiveLayout: "collapse",
      placeholder: "Upload a stock file to start…",
      index: "id",
      selectable: true,
      reactiveData: true,

      rowFormatter: function(row){
        const d = row.getData();
        const act = toNumber(d.actualQty);
        const sys = Number(d.systemQty)||0;
        const varr = (act === null) ? null : (act - sys);

        if(act === null){
          row.getElement().style.background = "rgba(251,191,36,.06)";
        }else if(Math.abs(varr) < 1e-9){
          row.getElement().style.background = "rgba(34,197,94,.06)";
        }else if(varr < 0){
          row.getElement().style.background = "rgba(239,68,68,.06)";
        }else{
          row.getElement().style.background = "rgba(45,212,191,.06)";
        }
      },

      columns: [
        {title:"", formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:52},
        {title:"#", field:"id", width:70, hozAlign:"center", headerSort:true},
        {title:"Item Name", field:"itemName", minWidth:320, headerSort:true},
        {title:"System Qty (PackQty)", field:"systemQty", width:180, hozAlign:"right",
          formatter:(c)=> fmtNum(Number(c.getValue()||0))
        },
        {title:"Actual Qty", field:"actualQty", width:140, hozAlign:"right",
          editor:"number",
          editorParams:{min:0, step:1},
          cellEdited:(cell)=>{
            const row = cell.getRow();
            row.update(computeRow(row.getData()));
            persistActualFromTable();
            updateSummary();
          }
        },
        {title:"Variance (Actual − System)", field:"variance", width:220, hozAlign:"center", formatter:varianceFormatter},
        {title:"Status", field:"status", width:160, hozAlign:"center", formatter:statusBadgeFormatter},
      ],

      initialSort: [{column:"itemName", dir:"asc"}],

      rowSelectionChanged: function(){
        updateSelectedInfo();
        const rows = table.getSelectedRows();
        if(rows.length === 1){
          const d = rows[0].getData();
          const v = toNumber(d.actualQty);
          document.getElementById("actualBox").value = (v === null ? "" : v);
        }
      }
    });
  }

  // ---------- Apply Actual ----------
  function applyActualToSelected(value){
    if(!table) return;
    const selected = table.getSelectedRows();
    if(!selected.length){
      toast("No items selected.", "Select row(s) from the table first.");
      return;
    }
    const v = toNumber(value);
    if(v === null){
      toast("Actual Qty is empty/invalid.", "Enter a number, then click Apply.");
      return;
    }

    selected.forEach(row=>{
      const d = row.getData();
      d.actualQty = v;
      row.update(computeRow(d));
    });

    persistActualFromTable();
    updateSummary();
    toast("Actual applied.", `Updated ${selected.length} selected item(s).`);
  }

  function clearActualForSelected(){
    if(!table) return;
    const selected = table.getSelectedRows();
    if(!selected.length){
      toast("No items selected.", "Select row(s) from the table first.");
      return;
    }
    selected.forEach(row=>{
      const d = row.getData();
      d.actualQty = "";
      row.update(computeRow(d));
    });
    persistActualFromTable();
    updateSummary();
    toast("Cleared Actual Qty.", `Cleared ${selected.length} selected item(s).`);
  }

  // ---------- Selection utilities ----------
  function selectAllFiltered(){
    if(!table) return;
    const rows = table.getRows("active");
    rows.forEach(r => r.select());
    updateSelectedInfo();
    toast("Selected all filtered rows.", `${rows.length} row(s) selected.`);
  }

  function clearSelection(){
    if(!table) return;
    table.deselectRow();
    updateSelectedInfo();
  }

  // ---------- Export helpers ----------
  function getActiveData(){
    if(!table) return [];
    return table.getRows("active").map(r => r.getData());
  }

  function computePdfSummary(allRows){
    const total = allRows.length;
    const counted = allRows.filter(r => toNumber(r.actualQty) !== null).length;
    const mismatched = allRows.filter(r => {
      const act = toNumber(r.actualQty);
      if(act === null) return false;
      const sys = Number(r.systemQty)||0;
      return Math.abs(act - sys) >= 1e-9;
    }).length;
    return { total, counted, mismatched };
  }

  // ---------- Export Excel (filtered view) ----------
  function exportExcel(){
    const data = getActiveData();
    if(!data.length){
      toast("Nothing to export.", "Upload a file first (or clear filters).");
      return;
    }

    const out = data.map(r=>{
      const sys = Number(r.systemQty)||0;
      const act = toNumber(r.actualQty);
      const variance = (act === null) ? "" : (act - sys);
      const status =
        act === null ? "Not counted" :
        (Math.abs(variance) < 1e-9 ? "Match" : (variance > 0 ? "Surplus" : "Shortage"));

      return {
        "#": r.id,
        "Item Name": r.itemName,
        "System Qty (PackQty)": sys,
        "Actual Qty (Manual)": act === null ? "" : act,
        "Variance (Actual-System)": variance,
        "Status": status,
      };
    });

    const ws = XLSX.utils.json_to_sheet(out, { skipHeader:false });
    ws["!cols"] = [{wch:6}, {wch:45}, {wch:18}, {wch:18}, {wch:20}, {wch:14}];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Variance Report");

    const fname = `ICU_Stock_Variance_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, fname);
    toast("Excel exported.", fname);
  }

  // ---------- Export PDF (A4 portrait, filtered view) ----------
  function exportPDF_A4_portrait(){
    const data = getActiveData();
    if(!data.length){
      toast("Nothing to export.", "Upload a file first (or clear filters).");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" }); // A4 portrait

    const all = table ? table.getData() : [];
    const s = computePdfSummary(all);

    const title = "ICU Stock Variance Report";
    const meta1 = lastLoadedFilename ? `File: ${lastLoadedFilename}` : "File: (not specified)";
    const meta2 = `Generated: ${new Date().toLocaleString()}`;
    const meta3 = `Total items: ${s.total} | Counted: ${s.counted} | Mismatched: ${s.mismatched}`;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text(title, 14, 16);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(meta1, 14, 22);
    doc.text(meta2, 14, 27);
    doc.text(meta3, 14, 32);

    const body = data.map(r=>{
      const sys = Number(r.systemQty)||0;
      const act = toNumber(r.actualQty);
      const varr = (act === null) ? "" : (act - sys);
      const status =
        act === null ? "Not counted" :
        (Math.abs(varr) < 1e-9 ? "Match" : (varr > 0 ? "Surplus" : "Shortage"));

      return [
        r.id,
        r.itemName,
        fmtNum(sys),
        act === null ? "" : fmtNum(act),
        (varr === "" ? "" : fmtNum(varr)),
        status
      ];
    });

    doc.autoTable({
      startY: 38,
      head: [["#", "Item Name", "System Qty", "Actual Qty", "Variance", "Status"]],
      body,
      styles: { fontSize: 9, cellPadding: 2.1, overflow: "linebreak" },
      headStyles: { fillColor: [7, 27, 42] },
      alternateRowStyles: { fillColor: [4, 17, 31] },
      margin: { left: 14, right: 14 },
      columnStyles: {
        0: { cellWidth: 10 },
        1: { cellWidth: 72 },
        2: { cellWidth: 24 },
        3: { cellWidth: 22 },
        4: { cellWidth: 22 },
        5: { cellWidth: 28 },
      },
      didDrawPage: () => {
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth  = doc.internal.pageSize.getWidth();
        const pageNumber = doc.internal.getNumberOfPages();

        doc.setFontSize(9);
        doc.setTextColor(160);
        doc.text("Designed by Mr. Mohamed Ghonim - ICU head Nurse", 14, pageHeight - 10);

        const txt = `Page ${pageNumber}`;
        doc.text(txt, pageWidth - 14 - doc.getTextWidth(txt), pageHeight - 10);

        doc.setTextColor(0);
      },
    });

    const fname = `ICU_Stock_Variance_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fname);
    toast("PDF exported (A4 portrait).", fname);
  }

  // ---------- Mismatch Only PDF (A4 portrait, within filtered view) ----------
  function getMismatchOnlyData(){
    const data = getActiveData(); // mismatch inside current filters
    return data.filter(r=>{
      const act = toNumber(r.actualQty);
      if(act === null) return false;
      const sys = Number(r.systemQty)||0;
      return Math.abs(act - sys) >= 1e-9;
    });
  }

  function exportPDF_MismatchOnly_A4_portrait(){
    const data = getMismatchOnlyData();
    if(!data.length){
      toast("No mismatches found.", "Mismatch-only PDF needs counted items with Variance ≠ 0 (within current filters).");
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" }); // A4 portrait

    const title = "ICU Stock Variance Report (Mismatch Only)";
    const meta1 = lastLoadedFilename ? `File: ${lastLoadedFilename}` : "File: (not specified)";
    const meta2 = `Generated: ${new Date().toLocaleString()}`;
    const meta3 = `Mismatched items (filtered): ${data.length}`;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text(title, 14, 16);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text(meta1, 14, 22);
    doc.text(meta2, 14, 27);
    doc.text(meta3, 14, 32);

    const body = data.map(r=>{
      const sys = Number(r.systemQty)||0;
      const act = toNumber(r.actualQty);
      const varr = (act === null) ? "" : (act - sys);
      const status = (varr > 0 ? "Surplus" : "Shortage");

      return [
        r.id,
        r.itemName,
        fmtNum(sys),
        act === null ? "" : fmtNum(act),
        (varr === "" ? "" : fmtNum(varr)),
        status
      ];
    });

    doc.autoTable({
      startY: 38,
      head: [["#", "Item Name", "System Qty", "Actual Qty", "Variance", "Status"]],
      body,
      styles: { fontSize: 9, cellPadding: 2.1, overflow: "linebreak" },
      headStyles: { fillColor: [7, 27, 42] },
      alternateRowStyles: { fillColor: [4, 17, 31] },
      margin: { left: 14, right: 14 },
      columnStyles: {
        0: { cellWidth: 10 },
        1: { cellWidth: 72 },
        2: { cellWidth: 24 },
        3: { cellWidth: 22 },
        4: { cellWidth: 22 },
        5: { cellWidth: 28 },
      },
      didDrawPage: () => {
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth  = doc.internal.pageSize.getWidth();
        const pageNumber = doc.internal.getNumberOfPages();

        doc.setFontSize(9);
        doc.setTextColor(160);
        doc.text("Designed by Mr. Mohamed Ghonim - ICU head Nurse", 14, pageHeight - 10);

        const txt = `Page ${pageNumber}`;
        doc.text(txt, pageWidth - 14 - doc.getTextWidth(txt), pageHeight - 10);

        doc.setTextColor(0);
      },
    });

    const fname = `ICU_Stock_Mismatch_Only_${new Date().toISOString().slice(0,10)}.pdf`;
    doc.save(fname);
    toast("Mismatch-only PDF exported (A4 portrait).", fname);
  }

  // ---------- Events ----------
  document.getElementById("searchBox").addEventListener("input", applyFilters);
  document.getElementById("varianceFilter").addEventListener("change", applyFilters);

  document.getElementById("btnApplyActual").addEventListener("click", ()=>{
    applyActualToSelected(document.getElementById("actualBox").value);
  });
  document.getElementById("actualBox").addEventListener("keydown", (e)=>{
    if(e.key === "Enter") applyActualToSelected(e.target.value);
  });

  document.getElementById("btnClearSelected").addEventListener("click", clearActualForSelected);

  document.getElementById("btnExportExcel").addEventListener("click", exportExcel);
  document.getElementById("btnExportPDF").addEventListener("click", exportPDF_A4_portrait);
  document.getElementById("btnExportMismatchPDF").addEventListener("click", exportPDF_MismatchOnly_A4_portrait);

  document.getElementById("btnResetActual").addEventListener("click", ()=>{
    if(!table) return;
    const rows = table.getData().map(r=>{
      r.actualQty = "";
      return computeRow(r);
    });
    table.replaceData(rows);
    persistActualFromTable();
    updateSummary();
    toast("Reset done.", "All Actual Qty values cleared.");
  });

  document.getElementById("btnClearTable").addEventListener("click", ()=>{
    if(table){
      table.clearData();
      updateSummary();
      updateSelectedInfo();
    }
    lastLoadedFilename = "";
    setFileLabel("");
    toast("Table cleared.");
  });

  document.getElementById("btnSelectAllFiltered").addEventListener("click", selectAllFiltered);
  document.getElementById("btnClearSelection").addEventListener("click", clearSelection);

  document.getElementById("btnLoadSaved").addEventListener("click", ()=>{
    if(!table || table.getDataCount() === 0){
      toast("No table data.", "Upload a file first, then load saved actual values.");
      return;
    }
    fillActualFromSaved();
  });

  document.getElementById("btnClearSaved").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    toast("Saved data cleared.", "This only clears data from this browser.");
  });

  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;

    try{
      toast("Reading file…", file.name);
      lastLoadedFilename = file.name;

      const aoa = await parseFileToAOA(file);
      const group = document.getElementById("aggMode").value === "itemname";
      const rows = buildRowsFromAOA(aoa, { groupByItemName: group });

      initTable();
      table.setData(rows);

      updateSelectedInfo();
      updateSummary();
      applyFilters();

      setFileLabel(file.name);
      toast("File imported successfully.", `Items loaded: ${rows.length}`);
    }catch(err){
      console.error(err);
      toast("Import failed.", String(err?.message || err));
    }
  });

  // init
  initTable();
  updateSummary();
  updateSelectedInfo();
</script>
</body>
</html>

